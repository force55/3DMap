<?phpfunction create_route_callback(){    check_ajax_referer('myajax-nonce', 'nonce_code');    $name = $_POST['data']['name'];    $points = $_POST['data']['points'];    $propose_to_public = $_POST['data']['propose_to_public'];    $description = $_POST['data']['route-description-ua'];    $descriptionEn = $_POST['data']['route-description-en'];    $status = '';    $message = '';    $status = $propose_to_public == 'true' ? 'pending' : 'private';    $updated_points = array();    foreach ($points as $key => $point) {        $new_point = str_replace('marker-wordpress-id-', '', $point);        $updated_points[]["point"] = $new_point;        $point = get_post($new_point);        if ($propose_to_public == 'true') {            if ($point->post_status == 'private' or $point->post_status == 'pending') {                wp_send_json_error(array(                    'message' => 'Для того, щоб опублікувати маршрут всі його точки повинні бути опубліковані!',                    'url' => ''                ));                die();            }        }    }    $args = array(        'post_type' => 'routes',        'post_title' => $name,        'post_status' => $status,        'post_author' => get_current_user_id()    );    $route_id = wp_insert_post(wp_slash($args));    update_field('title_route', $name, $route_id);    // save a repeater field value    $field_key = "field_5f281a746c89e";    $value = $updated_points;    update_field($field_key, $value, $route_id);    update_field('opys_route', $description, $route_id);    //English route    global $polylang;    $args = array(        'post_title' => $name . '_en',        'post_status' => $status,        'post_type' => 'routes',        'post_author' => get_current_user_id()    );    $routeEn = wp_insert_post(wp_slash($args), true);    $polylang->model->set_post_language($routeEn, 'en');    $polylang->model->save_translations('post', $route_id, array('en' => $routeEn));    update_field('title_route', $name, $routeEn);    foreach ($points as $key => $point) {        $new_point = str_replace('marker-wordpress-id-', '', $point);        $updated_points[]["point"] = $new_point;    }    // save a repeater field value    $field_key = "field_5f281a746c89e";    $value = $updated_points;    update_field($field_key, $value, $routeEn);    update_field('opys_route', $descriptionEn, $routeEn);    if ($propose_to_public == 'true') {        $message = 'Ваш маршрут був вiдправлений на модерацiю';    } else {        $message = 'Маршрут був вдало створений';    }    $url_return = home_url();    wp_send_json_success(        array(            'success' => true,            'message' => $message,            'route_id' => $route_id,            'routeEn' => $routeEn,            'url' => $url_return        )    );}add_action('wp_ajax_nopriv_create_route', 'create_route_callback');add_action('wp_ajax_create_route', 'create_route_callback');function add_favorite_route_callback(){    check_ajax_referer('myajax-nonce', 'nonce_code');    $id_route = $_POST['data']['id_route'];    $id_user = get_current_user_id();    $url_return = home_url();    if (!is_user_logged_in()) {        wp_send_json_success(array(            'message' => 'Увійдіть в систему, будь ласка, щоб додати маршрут в улюблені',            'url' => ''        ));        die();    }    add_post_meta($id_route, 'vaforite_route_' . $id_user, '1');    wp_send_json_success(array(        'message' => 'Маршрут успiшно доданий в улюбленi',        'url' => $url_return    ));}add_action('wp_ajax_nopriv_add_favorite_route', 'add_favorite_route_callback');add_action('wp_ajax_add_favorite_route', 'add_favorite_route_callback');function delete_favorite_route_callback(){    check_ajax_referer('myajax-nonce', 'nonce_code');    $id_route = $_POST['data']['id_route'];    $id_user = get_current_user_id();    update_post_meta($id_route, 'vaforite_route_' . $id_user, '0');    $url_return = home_url();    wp_send_json_success(array(        'status' => 'sucess',        'message' => 'Маршрут успiшно видалений з улюблених',        'url' => $url_return    ));}add_action('wp_ajax_nopriv_delete_favorite_route', 'delete_favorite_route_callback');add_action('wp_ajax_delete_favorite_route', 'delete_favorite_route_callback');function edit_route_callback(){    check_ajax_referer('myajax-nonce', 'nonce_code');    $route = $_POST['route-id'];    $title = $_POST['route-title'];    $descrUa = $_POST['route-description-ua'];    $descrEng = $_POST['route-description-en'];    $virtualRoute = $_POST['virtual'];    $realRoute = $_POST['real'];    $pointsLength = $_POST['length_points'];    $imgRoute = $_FILES['route-image'];    $audioRoute = $_FILES['route-audio'];    $proposeToPublic = $_POST['made-public'];    $points = explode(',',$_POST['points_route']);    for ($i = 0; $i < count($points); $i++) {        $updated_points[]["point"] = $points[$i];        $point = get_post((int)$points[$i]);        if ( ( $point->post_status == 'private' or $point->post_status == 'pending'  ) and $proposeToPublic) {            wp_send_json_error(array(                'message' => 'Для того, щоб опублікувати маршрут, всі його точки повинні бути опубліковані!',                'url' => ''            ));        }    }    //translate to english language ( polylang )    global $polylang;    $routeEn = pll_get_post($route, 'en');    if ($proposeToPublic) {        $my_route = array();        $my_route['ID'] = $route;        $my_route['post_status'] = 'pending';        wp_update_post(wp_slash($my_route));        $my_route_En = array();        $my_route_En['ID'] = $routeEn;        $my_route_En['post_status'] = 'pending';        wp_update_post(wp_slash($my_route_En));    }    if ($title) {        update_field('title_route', $title, $route);    }    if ($descrUa) {        update_field('opys_route', $descrUa, $route);    }    if ($descrEng) {        update_field('opys_route', $descrEng, $routeEn);    }    update_field('virtualnyj_marshrut', $virtualRoute, $route);    update_field('virtualnyj_marshrut', $virtualRoute, $routeEn);    update_field('realnyj_marshrut', $realRoute, $route);    update_field('realnyj_marshrut', $realRoute, $routeEn);    // save a repeater field value    $field_key = "field_5f281a746c89e";    $value = $updated_points;    update_field($field_key, $value, $routeEn);    update_field($field_key, $value, $route);    if ($imgRoute['name'] != '') {        $imgRoute_upload = media_handle_upload('route-image', 0);        update_field('zadnyj_fon_route', $imgRoute_upload, $route);        update_field('zadnyj_fon_route', $imgRoute_upload, $routeEn);    }    if ($audioRoute['name'] != '') {        $imgRoute_upload = media_handle_upload('route-audio', 0);        update_field('audyo_route', $imgRoute_upload, $route);        update_field('audyo_route', $imgRoute_upload, $routeEn);    }    $url_return = home_url();    wp_send_json_success(array(        'status' => 'success',        'message' => 'Маршрут був вдало відредагований',        'url' => $url_return    ));    wp_die();}add_action('wp_ajax_nopriv_edit_route', 'edit_route_callback');add_action('wp_ajax_edit_route', 'edit_route_callback');function delete_route_callback(){    check_ajax_referer('myajax-nonce', 'nonce_code');    $id = $_POST['data']['id'];    global $polylang;    $id_eng = pll_get_post($id, 'en');    $update_post = array(        'post_type' => 'routes',        'ID' => $id,        'post_status' => 'trash'    );    $deactivate = wp_update_post($update_post);    $update_post_eng = array(        'post_type' => 'routes',        'ID' => $id_eng,        'post_status' => 'trash'    );    $deactivate_eng = wp_update_post($update_post_eng);    $url_return = home_url();    wp_send_json_success(array(        'status' => 'success',        'route' => $deactivate,        'route_eng_id' => $deactivate_eng,        'message' => 'Маршрут був видалений',        'url' => $url_return    ));}add_action('wp_ajax_nopriv_delete_route', 'delete_route_callback');add_action('wp_ajax_delete_route', 'delete_route_callback');